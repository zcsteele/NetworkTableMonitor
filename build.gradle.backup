/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java project to get you started.
 * For more details take a look at the Java Quickstart chapter in the Gradle
 * user guide available at https://docs.gradle.org/4.5.1/userguide/tutorial_java_projects.html
 */

plugins {
    // Apply the java plugin to add support for Java
    id 'java'

    // Apply the application plugin to add support for building an application
    id 'application'
}

// Define the main class for the application
mainClassName = 'Monitor'

ext.buildType = 'linux'

ext.packageName = { ->
    if (buildType == "linux") {
      return "desktop"
    } else if (buildType == "windows") {
      return "windows2015"
    } 
    return buildType
}

ext.networkTables = { ->
    System.out.println 'inspecting ntcore()'
    def pkg = packageName()
    System.out.println "packageName is $pkg"
    return "edu.wpi.first.wpilib.networktables.java:NetworkTables:+:$pkg"
}

//ext.ntcore = { ->
//    def pkg = packageName()
//    return "edu.wpi.first.ntcore.ntcore-java:ntcore-java:+"
//}

dependencies {
    // This dependency is found on compile classpath of this component and consumers.
    compile networkTables()
    compile 'com.google.guava:guava:23.0'
    // Might need ot unzip jar to get *.so files out
//    compile 'edu.wpi.first.ntcore:ntcore-jni:+'
    compile 'edu.wpi.first.ntcore:ntcore-java:+'

    // Use JUnit test framework
    testCompile 'junit:junit:4.12'
}

ext.ntcoreUnzipLocation = "$buildDir/ntcore"
def getNtcore() {
  System.out.println "Running getNtcore"
  def packageName = "edu.wpi.first.ntcore:ntcore-jni:+:linuxx86-64@jar"
  def dependency = project.dependencies.create(packageName)
  def config = project.configurations.detachedConfiguration(dependency)
  config.setTransitive(false) 
  return config.files[0].canonicalFile
}
task downloadNtcore() {
  group = 'getNtcore'
  def depFolder = "$buildDir/dependencies"
  def ntZip = file("$depFolder/ntcore.zip")
  outputs.file(ntZip)
  def openNt
  doFirst {
    openNt = getNtcore()
  }
  doLast {
    copy {
      from openNt
      rename 'ntcore(.+)', 'ntcore.zip'
      into depFolder
    }
  }
}
task UnzipNtcore() {
  group = 'getNtcore'
  dependsOn downloadNtcore
  copy {
    from zipTree(downloadNtcore.outputs.files.singleFile)
    into ntcoreUnzipLocation
  }
}

// In this section you declare where to find the dependencies of your project
repositories {
    jcenter()
    mavenCentral()
    maven { url "http://first.wpi.edu/FRC/roborio/maven/release" }
}

jar {
    manifest {
	attributes 'Main-Class': 'org.snobotics.NetworkTable.Monitor'
    }
}

build.dependsOn UnzipNtcore
//build.dependsOn downloadNtcore
